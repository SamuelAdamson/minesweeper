@*
	Timer UI Component
	Samuel Adamson
*@
@using Microsoft.AspNetCore.Components.Web;
@using minesweeper.Models.CustomEventArgs;
@using System.Threading;
@implements IDisposable;

<div class="TimerUI">
	<h3 class="display-6 time">@timeElapsed</h3>
	<div class="timer-row">
		<button class="btn timer-btn" @onclick="OnPause">@pauseMsg</button>
		<button class="btn timer-btn" @onclick="OnReset">reset</button>
	</div>
</div>

@code {
	// Events
	public event EventHandler<TimerEventArgs> Pause;
	public event EventHandler<TimerEventArgs> Unpause;
	public event EventHandler<TimerEventArgs> Reset;

	// Declare timer
	Timer gameTimer;
	int gameTime, hours, minutes, seconds;
	string timeElapsed, pauseMsg;
	bool paused;

	/// <summary>
	/// Constructor
	/// </summary>
	public TimerUI()
	{
		// Game not paused
		paused = false;
		pauseMsg = "pause";

		// Initialize time string
		timeElapsed = "00:00:00";

		// Start timer
		SetTimer();
		StartTimer();
	}

	// Access control
	public bool Paused { get => paused; }

	/// <summary>
	/// Create a new timer with duetime
	/// </summary>
	/// <param name="dueTime"></param>
	private void NewTimer(int dueTime)
	{
		gameTimer = new Timer(OnGameTimerTick, null, dueTime, 1000);
	}

	/// <summary>
	/// Callback for timer
	/// </summary>
	/// <param name="stateInfo"></param>
	private void OnGameTimerTick(Object? stateInfo)
	{	
		// Update gametime
		gameTime++;
		hours = gameTime / 3600;
		minutes = gameTime / 60;
		seconds = gameTime % 60;

		// Set elapsed time and update state
		SetTimeElapsed();
	}

	/// <summary>
	/// Update time elapsed
	/// </summary>
	private void SetTimeElapsed()
	{
		timeElapsed = $"{hours.ToString("D2")}:{minutes.ToString("D2")}:{seconds.ToString("D2")}";
		InvokeAsync(() => { StateHasChanged(); });
	}

	/// <summary>
	/// On Pause click
	/// </summary>
	private void OnPause()
	{
		if(paused) // Check already Paused
		{
			// Unpause GUI and raise the unpause event
			UnpauseUI();
			RaiseUnpause();
		}
		else
		{
			// Pause GUI and raise pause event
			PauseUI();
			RaisePause();
		}
	}

	/// <summary>
	/// On Restart Click
	/// </summary>
	private void OnReset()
	{
		ResetUI();
		RaiseReset();
	}

	/// <summary>
	/// Raise Pause Event
	/// </summary>
	protected virtual void RaisePause()
	{
		Pause?.Invoke(this, new TimerEventArgs("Game Paused!"));
	}

	/// <summary>
	/// Raise Unpause Event
	/// </summary>
	protected virtual void RaiseUnpause()
	{
		Unpause?.Invoke(this, new TimerEventArgs("Game Unpaused!"));
	}

	/// <summary>
	/// Raise reset event
	/// </summary>
	protected virtual void RaiseReset()
	{
		Reset?.Invoke(this, new TimerEventArgs("Game Restarted!"));
	}

	/// <summary>
	/// Unpause UI - Start Timer Again
	/// </summary>
	public void UnpauseUI()
	{
		// Set pause message and create new timer (start ticks)
		NewTimer(500);
		pauseMsg = "pause";
		paused = false;
	}

	/// <summary>
	/// Pause UI - Stop Timer
	/// </summary>
	public void PauseUI()
	{
		// Set pause message and dispose of timer (stop ticks)
		Dispose();
		paused = true;
		pauseMsg = "unpause";
	}

	/// <summary>
	/// Reset UI - Reset time and timer
	/// </summary>
	public void ResetUI()
	{
		ResetTimer(); // Reset timer
		if (!paused) StartTimer();
		else Dispose();
	}

	/// <summary>
	/// Set timer to 00:00:00
	/// </summary>
	private void SetTimer()
	{
		// Reset values
		gameTime = 0;
		hours = 0;
		minutes = 0;
		seconds = 0;
	}

	/// <summary>
	/// Reset Timer to 00:00:00 and update elapsed time
	/// </summary>
	public void ResetTimer()
	{
		// Set timer values and set elapsed time
		SetTimer();
		SetTimeElapsed();
	}

	/// <summary>
	/// Dispose old timer, start a new timer
	/// </summary>
	public void StartTimer()
	{
		// Dispose of old timer and create new one
		Dispose();
		NewTimer(500);
	}

	/// <summary>
	/// Dispose - Idisposable
	/// </summary>
	public void Dispose()
	{
		gameTimer?.Dispose();
	}
}
